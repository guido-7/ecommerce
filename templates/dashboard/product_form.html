{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard/product_form.css' %}">
{% endblock %}

{% block content %}
<div class="col-md-8 offset-md-2">
    <div class="form-section">
        <h2 class="mb-4 text-center">
            <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus-circle{% endif %} text-primary me-2"></i>
            {% if form.instance.pk %}
                Edit Product: {{ form.instance.name }}
            {% else %}
                Add New Product
            {% endif %}
        </h2>

        <form id="productForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Sezione Informazioni Prodotto -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-info-circle me-2"></i>
                    Product Information
                </h5>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.category.id_for_label }}" class="form-label">
                            {{ form.category.label }} <span class="required-indicator">*</span>
                        </label>
                        {{ form.category }}
                        {% if form.category.errors %}
                            <div class="text-danger">{{ form.category.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            {{ form.name.label }} <span class="required-indicator">*</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="text-danger">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <label for="{{ form.brand.id_for_label }}" class="form-label">
                        {{ form.brand.label }} <span class="required-indicator">*</span>
                    </label>
                    {{ form.brand }}
                    {% if form.brand.errors %}
                    <div class="text-danger">{{ form.brand.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.description.id_for_label }}" class="form-label">
                        {{ form.description.label }}
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <div class="text-danger">{{ form.description.errors }}</div>
                    {% endif %}
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.price.id_for_label }}" class="form-label">
                            {{ form.price.label }} <span class="required-indicator">*</span>
                        </label>
                        {{ form.price }}
                        {% if form.price.errors %}
                            <div class="text-danger">{{ form.price.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ form.stock.id_for_label }}" class="form-label">
                            {{ form.stock.label }} <span class="required-indicator">*</span>
                        </label>
                        {{ form.stock }}
                        {% if form.stock.errors %}
                            <div class="text-danger">{{ form.stock.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Sezione Sconto -->
                <div class="discount-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-tag me-2"></i>
                            Discount Management
                        </h6>
                        <button type="button" class="discount-toggle" id="discountToggle">
                            <i class="fas fa-percent me-2"></i>
                            <span id="discountToggleText">Apply Discount</span>
                        </button>
                    </div>

                    <div class="discount-fields" id="discountFields">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.discounted_price.id_for_label }}" class="form-label">
                                    {{ form.discounted_price.label }}
                                </label>
                                {{ form.discounted_price }}
                                {% if form.discounted_price.errors %}
                                    <div class="invalid-feedback">{{ form.discounted_price.errors }}</div>
                                {% endif %}
                                <div class="invalid-feedback" id="discountPriceError" style="display: none;">
                                    The discounted price must be lower than the original price
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="price-comparison" id="priceComparison" style="display: none;">
                                    <div class="text-center">
                                        <div class="original-price" id="originalPriceDisplay">
                                            Original price: €0.00
                                        </div>
                                        <div class="discounted-price" id="discountedPriceDisplay">
                                            Discounted price: €0.00
                                        </div>
                                        <div class="savings" id="savingsDisplay">
                                            Savings: €0.00 (0%)
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sezione Immagini -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-images me-2"></i>
                    Product Images <span class="required-indicator">*</span>
                </h5>
                <p class="text-muted mb-3">
                    <i class="fas fa-info-circle me-1"></i>
                    At least one product photo is required
                </p>

                <!-- Immagini Esistenti (per modifica) -->
                {% if existing_images %}
                <div class="mb-4">
                    <h6>Current Images:</h6>
                    <div class="existing-images-container">
                        {% for image in existing_images %}
                        <div class="existing-image">
                            <img src="{{ image.image.url }}" alt="Immagine prodotto">
                            <button type="button" class="delete-existing-btn"
                                    onclick="markImageForDeletion({{ image.id }}, this)">
                                <i class="fas fa-times"></i>
                            </button>
                            <input type="hidden" name="delete_image" value="" id="delete_{{ image.id }}">
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Nuove Immagini -->
                <div id="imageContainer">
                    <!-- Le immagini saranno generate dinamicamente -->
                </div>

                <div class="text-center mt-3">
                    <button type="button" class="btn add-image-btn" id="addImageBtn">
                        <i class="fas fa-plus me-2"></i>
                        Add {% if existing_images %}another{% endif %} Image
                    </button>
                </div>
            </div>

            <!-- Pulsanti di Azione -->
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary btn-lg me-3">
                    <i class="fas fa-save me-2"></i>
                    {% if form.instance.pk %}Update{% else %}Save{% endif %} Product
                </button>
                <a href="{% url 'product_list' %}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times me-2"></i>
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

</script>
{% endblock %}